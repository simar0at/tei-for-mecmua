#!/bin/sh
mkdir -p Guidelines/Odds
mkdir -p Guidelines/en
cat >OldOdds<<EOF
altname.odd
biblpartphrase.odd
cbgeseq.odd
datatype.formula.odd
datatype.ucs.odd
digenxx.odd
dimixxx.odd  
drgenxx.odd
drmixxx.odd
lg1.odd
lg2.odd
lg3.odd
lg4.odd
lg5.odd
mcrend.odd
role.odd
segmixxx.odd
te-new.odd
tei.data.names.odd
tei.data.regexp.odd
tei2.odd
teifsd2.odd
tsgenxx.odd
tsmixxx.odd
vegen.odd
vegenxx.odd
vemix.odd
vemixxx.odd
EOF
# get rid of last lot
rm Guidelines/Odds/*.xml
rm Guidelines/en/*.xml

# copy all ODD files
for i in [A-Z]*/*.odd 
do
 cp $i Guidelines/Odds
done
for i in `cat OldOdds`
do
 rm Guidelines/Odds/$i
done

# move chapter files
rm -f chaps.sed
rm -f Guidelines/en/fileents.dtd 
rm -f ents.sed
for i in [A-Z]*
do
if test -d $i
then
 lower=`echo $i | tr '[A-Z]' '[a-z]'`
 if test -f Guidelines/Odds/$lower.odd
 then
   mv Guidelines/Odds/$lower.odd Guidelines/en/$i.xml
   echo 's/&'$lower.odd';/\&'$i.xml';/' >> chaps.sed
   echo "<!ENTITY" $i.xml SYSTEM '"'$i.xml'">' \
        >> Guidelines/en/fileents.dtd
 fi
fi
done


# make entity file and rename ODD to XML by @ident
for i in Guidelines/Odds/*.odd
do
 N=`xsltproc getident.xsl $i`
 X=`basename $i .odd`
 echo "<!ENTITY" $N SYSTEM '"'../Odds/$N.xml'">' \
        >> Guidelines/en/fileents.dtd
 echo 's/&'$X.odd';/\&'$N';/' >> ents.sed
 echo 's/&'$X';/\&'$N';/' >> ents.sed
 mv $i Guidelines/Odds/$N.xml
done
echo 's/&ppartmsdesc.odd;/\&model.pPart.msdesc;/' >> ents.sed
# now mangle chapter files
for i in Guidelines/en/*.xml
do
 sed -f ents.sed $i > tmp
 mv tmp $i
done

# get driver
sed -f chaps.sed ../Source-driver.xml >Guidelines/en/driver.xml
cp ../ents.dtd Guidelines/en/ents.dtd


#rm OldOdds chaps.sed ents.sed
